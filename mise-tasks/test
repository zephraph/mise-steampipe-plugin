#!/usr/bin/env bash
set -euo pipefail

# Link the plugin for testing
mise plugin link --force steampipe-plugin .

# Clear cache to ensure fresh testing
mise cache clear

echo "Testing plugin linking and basic functionality..."

# Test with the GitHub Steampipe plugin
TEST_TOOL="github"

echo "Testing version listing for steampipe-plugin:${TEST_TOOL}..."
if mise ls-remote steampipe-plugin:${TEST_TOOL} 2>/dev/null | head -5; then
    echo "✓ Version listing works"
else
    echo "✗ Version listing failed"
    exit 1
fi

echo ""
echo "Testing installation..."
if mise install steampipe-plugin:${TEST_TOOL}@1.7.0 2>/dev/null; then
    echo "✓ Installation works"

    # Plugins should be installed to steampipe's default location (~/.steampipe)
    # unless STEAMPIPE_INSTALL_DIR is set
    EXPECTED_DIR="${STEAMPIPE_INSTALL_DIR:-$HOME/.steampipe}"

    if [ -d "$EXPECTED_DIR/plugins" ]; then
        echo "✓ Plugins directory exists at: $EXPECTED_DIR/plugins"
    else
        echo "✗ Plugins directory not found at $EXPECTED_DIR/plugins"
        exit 1
    fi
else
    echo "✗ Installation failed"
    exit 1
fi

echo ""
echo "✓ All tests passed!"
echo ""
echo "Note: Steampipe plugins are database extensions, not standalone CLI tools."
echo "Plugins are installed to ${STEAMPIPE_INSTALL_DIR:-~/.steampipe} by default."
echo ""
echo "To use installed plugins with Steampipe:"
echo "  mise use steampipe-plugin:${TEST_TOOL}@1.7.0"
echo "  steampipe query \"select * from ${TEST_TOOL}_repository limit 1\""
echo ""
echo "To customize the install location, set STEAMPIPE_INSTALL_DIR before installing."
