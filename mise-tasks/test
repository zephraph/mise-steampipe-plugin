#!/usr/bin/env bash
set -euo pipefail

# Link the plugin for testing
mise plugin link --force steampipe-plugin .

# Clear cache to ensure fresh testing
mise cache clear

echo "Testing plugin linking and basic functionality..."

# Test with the GitHub Steampipe plugin
TEST_TOOL="github"

echo "Testing version listing for ${TEST_TOOL}..."
if mise ls-remote steampipe-plugin:${TEST_TOOL} 2>/dev/null | head -5; then
    echo "✓ Version listing works"
else
    echo "✗ Version listing failed"
    exit 1
fi

# Test installation
echo "Testing installation..."
if mise install steampipe-plugin:${TEST_TOOL}@1.7.0 2>/dev/null; then
    echo "✓ Installation works"

    # Note: Steampipe plugins are not standalone executables.
    # They are loaded by the main steampipe CLI.
    # We can verify the installation by checking if the plugin files exist.
    INSTALL_PATH=$(mise where steampipe-plugin:${TEST_TOOL}@1.7.0)

    if [ -d "$INSTALL_PATH" ]; then
        echo "✓ Plugin installed to: $INSTALL_PATH"

        # Check if the plugins directory exists
        if [ -d "$INSTALL_PATH/plugins" ]; then
            echo "✓ Plugins directory created"
        else
            echo "⚠ Plugins directory not found at $INSTALL_PATH/plugins"
        fi

        # Check if STEAMPIPE_INSTALL_DIR is set correctly
        STEAMPIPE_DIR=$(mise exec steampipe-plugin:${TEST_TOOL}@1.7.0 -- sh -c 'echo $STEAMPIPE_INSTALL_DIR')
        if [ "$STEAMPIPE_DIR" = "$INSTALL_PATH" ]; then
            echo "✓ STEAMPIPE_INSTALL_DIR environment variable set correctly"
        else
            echo "⚠ STEAMPIPE_INSTALL_DIR not set correctly. Expected: $INSTALL_PATH, Got: $STEAMPIPE_DIR"
        fi
    else
        echo "✗ Installation path not found"
        exit 1
    fi
else
    echo "✗ Installation failed"
    exit 1
fi

echo ""
echo "✓ All tests passed!"
echo ""
